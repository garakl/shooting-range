<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–µ—Ñ–µ—Ä–∞–Ω—Å: –°–æ—á–∏–Ω–∫–∞</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --felt-color: #27ae60;
            --text-color: #ecf0f1;
            --input-bg: #fff;
            --border-color: #bdc3c7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { margin-bottom: 10px; font-size: 1.5rem; }

        /* Setup Screen */
        #setup-screen {
            background: #34495e;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .input-group { margin: 10px 0; }
        input, select, button {
            padding: 10px;
            border-radius: 5px;
            border: none;
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
        }
        button {
            background-color: #e67e22;
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        button:hover { background-color: #d35400; }

        /* Game Screen */
        #game-screen { display: none; width: 100%; max-width: 800px; }

        /* Score Table */
        .score-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--felt-color);
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .score-table th, .score-table td {
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px;
            text-align: center;
            vertical-align: top;
            width: 25%; /* Will be adjusted by JS */
        }

        .player-header { font-weight: bold; font-size: 1.1rem; background: rgba(0,0,0,0.2); }
        .section-title { font-size: 0.8rem; text-transform: uppercase; opacity: 0.8; }
        
        .val-bullet { color: #f1c40f; font-weight: bold; font-size: 1.2rem; }
        .val-mountain { color: #e74c3c; font-weight: bold; font-size: 1.2rem; }
        .whist-grid { display: flex; flex-direction: column; gap: 2px; font-size: 0.9rem; }
        .whist-item { background: rgba(255,255,255,0.2); padding: 2px; border-radius: 3px; }

        /* Controls */
        .controls {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            display: grid;
            gap: 10px;
        }

        .control-row { display: flex; gap: 5px; flex-wrap: wrap; }
        .control-row > * { flex: 1; min-width: 80px; }
        
        .btn-add { background-color: #27ae60; }
        .btn-reset { background-color: #c0392b; margin-top: 20px; }
        .btn-calc { background-color: #2980b9; margin-top: 20px; }

        /* Results Modal */
        #result-area {
            margin-top: 20px;
            background: #fff;
            color: #333;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .result-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #ddd;
            padding: 5px 0;
        }
        .positive { color: green; font-weight: bold; }
        .negative { color: red; font-weight: bold; }

    </style>
</head>
<body>

    <h1>üÇ° –ü—Ä–µ—Ñ–µ—Ä–∞–Ω—Å (–°–æ—á–∏)</h1>

    <div id="setup-screen">
        <h3>–ù–æ–≤–∞—è –∏–≥—Ä–∞</h3>
        <div class="input-group">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤:</label>
            <select id="player-count" onchange="togglePlayerInputs()">
                <option value="3">3 –ò–≥—Ä–æ–∫–∞</option>
                <option value="4">4 –ò–≥—Ä–æ–∫–∞</option>
            </select>
        </div>
        <div id="names-inputs">
            <div class="input-group"><input type="text" id="p1-name" placeholder="–ò–≥—Ä–æ–∫ 1 (–ó–∞–ø–∞–¥)" value="–ó–∞–ø–∞–¥"></div>
            <div class="input-group"><input type="text" id="p2-name" placeholder="–ò–≥—Ä–æ–∫ 2 (–°–µ–≤–µ—Ä)" value="–°–µ–≤–µ—Ä"></div>
            <div class="input-group"><input type="text" id="p3-name" placeholder="–ò–≥—Ä–æ–∫ 3 (–í–æ—Å—Ç–æ–∫)" value="–í–æ—Å—Ç–æ–∫"></div>
            <div class="input-group" id="p4-group" style="display:none;"><input type="text" id="p4-name" placeholder="–ò–≥—Ä–æ–∫ 4 (–Æ–≥)" value="–Æ–≥"></div>
        </div>
        <button onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        <br><br>
        <small style="color:#bdc3c7">–ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∏–≥—Ä–∞, –æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</small>
    </div>

    <div id="game-screen">
        <table class="score-table" id="score-table">
            </table>

        <div class="controls">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –æ—á–∫–∏</h3>
            <div class="control-row">
                <select id="act-who"></select>
                <select id="act-type" onchange="toggleWhistTarget()">
                    <option value="bullet">–í –ø—É–ª—é (+)</option>
                    <option value="mountain">–í –≥–æ—Ä—É (-)</option>
                    <option value="whist">–í–∏—Å—Ç—ã</option>
                </select>
            </div>
            
            <div class="control-row">
                <input type="number" id="act-amount" placeholder="–°–∫–æ–ª—å–∫–æ –æ—á–∫–æ–≤?" inputmode="numeric">
                <select id="act-target" style="display:none;"></select>
            </div>

            <button class="btn-add" onclick="addScore()">–ó–∞–ø–∏—Å–∞—Ç—å</button>
        </div>

        <button class="btn-calc" onclick="calculateGame()">üèÅ –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥ (–†–∞—Å–ø–∏—Å–∞—Ç—å)</button>
        
        <div id="result-area"></div>

        <button class="btn-reset" onclick="resetGame()">üóë –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
    </div>

<script>
    // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã ---
    let gameState = {
        players: [], // { name, bullet, mountain, whists: {} }
        active: false,
        count: 3
    };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = function() {
        const saved = localStorage.getItem('prefSochiState');
        if (saved) {
            gameState = JSON.parse(saved);
            if (gameState.active) {
                renderGame();
            }
        }
    };

    function togglePlayerInputs() {
        const count = document.getElementById('player-count').value;
        document.getElementById('p4-group').style.display = (count == 4) ? 'block' : 'none';
    }

    function toggleWhistTarget() {
        const type = document.getElementById('act-type').value;
        const targetSelect = document.getElementById('act-target');
        targetSelect.style.display = (type === 'whist') ? 'block' : 'none';
    }

    function startGame() {
        const count = parseInt(document.getElementById('player-count').value);
        gameState.count = count;
        gameState.players = [];
        gameState.active = true;

        for (let i = 1; i <= count; i++) {
            const name = document.getElementById(`p${i}-name`).value || `–ò–≥—Ä–æ–∫ ${i}`;
            // whists - –æ–±—ä–µ–∫—Ç, –≥–¥–µ –∫–ª—é—á - –∏–Ω–¥–µ–∫—Å –∏–≥—Ä–æ–∫–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–∏—à–µ–º
            gameState.players.push({
                name: name,
                bullet: 0,
                mountain: 0,
                whists: Array(count).fill(0) 
            });
        }

        saveState();
        renderGame();
    }

    function saveState() {
        localStorage.setItem('prefSochiState', JSON.stringify(gameState));
    }

    function resetGame() {
        if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.")) {
            localStorage.removeItem('prefSochiState');
            location.reload();
        }
    }

    // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ ---
    function renderGame() {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        
        const table = document.getElementById('score-table');
        table.innerHTML = '';
        const count = gameState.players.length;

        // Header Row
        let headerHtml = '<tr>';
        gameState.players.forEach(p => {
            headerHtml += `<td class="player-header">${p.name}</td>`;
        });
        headerHtml += '</tr>';

        // Bullet Row
        let bulletHtml = '<tr>';
        gameState.players.forEach(p => {
            bulletHtml += `<td><div class="section-title">–ü—É–ª—è</div><div class="val-bullet">${p.bullet}</div></td>`;
        });
        bulletHtml += '</tr>';

        // Mountain Row
        let mountHtml = '<tr>';
        gameState.players.forEach(p => {
            mountHtml += `<td><div class="section-title">–ì–æ—Ä–∞</div><div class="val-mountain">${p.mountain}</div></td>`;
        });
        mountHtml += '</tr>';

        // Whists Row
        let whistHtml = '<tr>';
        gameState.players.forEach((p, idx) => {
            let wDetails = '<div class="whist-grid">';
            p.whists.forEach((amount, targetIdx) => {
                if (idx !== targetIdx) {
                    const targetName = gameState.players[targetIdx].name;
                    wDetails += `<div class="whist-item">–ù–∞ ${targetName}: <b>${amount}</b></div>`;
                }
            });
            wDetails += '</div>';
            whistHtml += `<td><div class="section-title">–í–∏—Å—Ç—ã</div>${wDetails}</td>`;
        });
        whistHtml += '</tr>';

        table.innerHTML = headerHtml + bulletHtml + mountHtml + whistHtml;

        updateDropdowns();
    }

    function updateDropdowns() {
        const whoSelect = document.getElementById('act-who');
        const targetSelect = document.getElementById('act-target');
        
        // Save current selection if possible
        const currWho = whoSelect.value;
        const currTarget = targetSelect.value;

        whoSelect.innerHTML = '';
        targetSelect.innerHTML = '';

        gameState.players.forEach((p, idx) => {
            let opt = new Option(p.name, idx);
            whoSelect.add(opt);
            
            let opt2 = new Option(`–ù–∞ ${p.name}`, idx);
            targetSelect.add(opt2);
        });

        if (currWho) whoSelect.value = currWho;
        // Don't restore target strictly as it depends on logic, but default is fine
    }

    // --- –õ–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—á–∫–æ–≤ ---
    function addScore() {
        const whoIdx = parseInt(document.getElementById('act-who').value);
        const type = document.getElementById('act-type').value;
        const amount = parseInt(document.getElementById('act-amount').value);
        const targetIdx = parseInt(document.getElementById('act-target').value);

        if (isNaN(amount)) {
            alert("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—á–∫–æ–≤!");
            return;
        }

        if (type === 'bullet') {
            gameState.players[whoIdx].bullet += amount;
        } else if (type === 'mountain') {
            gameState.players[whoIdx].mountain += amount;
        } else if (type === 'whist') {
            if (whoIdx === targetIdx) {
                alert("–ù–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å –≤–∏—Å—Ç—ã –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è!");
                return;
            }
            gameState.players[whoIdx].whists[targetIdx] += amount;
        }

        document.getElementById('act-amount').value = '';
        saveState();
        renderGame();
    }

    // --- –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç (–°–æ—á–∏–Ω–∫–∞) ---
    function calculateGame() {
        const players = JSON.parse(JSON.stringify(gameState.players)); // Copy for calc
        const N = players.length;
        const results = new Array(N).fill(0);

        // 1. –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—É–ª–∏
        // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –ø—É–ª—é
        let maxBullet = 0;
        players.forEach(p => { if(p.bullet > maxBullet) maxBullet = p.bullet; });

        // –£ –∫–æ–≥–æ –º–µ–Ω—å—à–µ –º–∞–∫—Å. –ø—É–ª–∏ - —Ä–∞–∑–Ω–∏—Ü—É –¥–æ–±–∞–≤–ª—è–µ–º –≤ –≥–æ—Ä—É
        players.forEach(p => {
            const diff = maxBullet - p.bullet;
            if (diff > 0) {
                p.mountain += diff;
                // –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–∞—Ä–∏–∞—Ü–∏—è—Ö –ø—É–ª—è –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è, 
                // –Ω–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –≤ –≥–æ—Ä—É - —Ç–æ –∂–µ —Å–∞–º–æ–µ.
            }
        });

        // 2. –ê–º–Ω–∏—Å—Ç–∏—è –≥–æ—Ä—ã (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏, –Ω–æ –ø—Ä–∏–≤—ã—á–Ω–æ)
        let minMount = players[0].mountain;
        players.forEach(p => { if(p.mountain < minMount) minMount = p.mountain; });
        players.forEach(p => p.mountain -= minMount);

        // 3. –†–∞—Å—á–µ—Ç
        // –§–æ—Ä–º—É–ª–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã (A –∏ B):
        // –û—á–∫–∏ A = (–í–∏—Å—Ç—ã A –Ω–∞ B - –í–∏—Å—Ç—ã B –Ω–∞ A) + (–ì–æ—Ä–∞ B - –ì–æ—Ä–∞ A) * 10 / N
        
        for (let i = 0; i < N; i++) {
            for (let j = 0; j < N; j++) {
                if (i === j) continue;

                // –†–∞–∑–Ω–∏—Ü–∞ –≤–∏—Å—Ç–æ–≤
                let whistDiff = players[i].whists[j] - players[j].whists[i];
                
                // –†–∞–∑–Ω–∏—Ü–∞ –≥–æ—Ä (–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è)
                // –ï—Å–ª–∏ —É J –≥–æ—Ä–∞ –±–æ–ª—å—à–µ, —á–µ–º —É I, —Ç–æ I –ø–æ–ª—É—á–∞–µ—Ç –æ—á–∫–∏
                let mountDiff = (players[j].mountain - players[i].mountain);
                let mountComp = (mountDiff * 10) / N;

                results[i] += whistDiff + mountComp;
            }
        }

        // –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        const resDiv = document.getElementById('result-area');
        resDiv.style.display = 'block';
        let html = '<h3>–ò—Ç–æ–≥ (–í–∏—Å—Ç—ã):</h3>';
        
        let checkSum = 0;

        results.forEach((score, idx) => {
            const roundedScore = Math.round(score); // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ü–µ–ª—ã—Ö
            checkSum += roundedScore;
            const colorClass = roundedScore >= 0 ? 'positive' : 'negative';
            const sign = roundedScore > 0 ? '+' : '';
            html += `
                <div class="result-row">
                    <span>${players[idx].name}</span>
                    <span class="${colorClass}">${sign}${roundedScore}</span>
                </div>
            `;
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 0 –∏–ª–∏ –±–ª–∏–∑–∫–∞ –∫ 0 –∏–∑-–∑–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è)
        html += `<small style="color:gray">–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞: ${checkSum} (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0)</small>`;

        resDiv.innerHTML = html;
        resDiv.scrollIntoView({ behavior: 'smooth' });
    }

</script>
</body>
</html>